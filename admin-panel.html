<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel â€“ ERT Odisha</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config = { theme: { extend: { colors: { sky: '#3A86FF', sun: '#FFBE0B', dark: '#1A1A2E', bg: '#F0F7FF', emerald: '#06D6A0', rose: '#FF6B6B'}, fontFamily: { baloo: ['"Baloo 2"', 'cursive'], nunito: ['Nunito', 'sans-serif']}}}}</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
  body { font-family: 'Nunito', sans-serif; background-color: #F0F7FF; }
  .ql-container { font-family: 'Nunito', sans-serif; font-size: 1rem; background: white; border-radius: 0 0 8px 8px; min-height: 200px;}
  .ql-toolbar { background: #f8fafc; border-radius: 8px 8px 0 0; }
  ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
</style>
</head>
<body class="text-slate-700">

  <!-- INITIAL LOADER -->
  <div id="auth-loader" class="min-h-screen flex items-center justify-center bg-dark">
    <div class="text-white font-bold text-xl animate-pulse">Checking Security Clearance...</div>
  </div>

  <div id="login-screen" class="hidden min-h-screen flex items-center justify-center bg-dark p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
      <div class="text-5xl mb-4">ğŸ›¡ï¸</div>
      <h1 class="font-baloo text-3xl font-bold text-dark mb-2">Admin Portal</h1>
      <p class="text-slate-500 mb-6 text-sm">Logging in as <strong class="text-dark">admin@ertodisha.in</strong></p>
      
      <form id="login-form" class="space-y-4">
        <input type="password" id="admin-password" placeholder="Admin Password" required class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 outline-none text-center">
        <button type="submit" id="login-btn" class="w-full bg-sky text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition shadow-lg">Access Secure DB</button>
      </form>
    </div>
  </div>

  <div id="dashboard" class="hidden min-h-screen flex flex-col">
    <header class="bg-white shadow-sm sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-10 h-10 bg-dark text-white rounded-lg flex items-center justify-center text-xl">ğŸ›¡ï¸</div>
          <span class="font-baloo text-xl font-bold text-dark hidden sm:block">ERT <span class="text-sky">Odisha</span> Admin</span>
        </div>
        <button onclick="logout()" class="text-sm font-bold text-slate-500 hover:text-rose">Logout</button>
      </div>
    </header>

    <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex items-center justify-between">
          <div><p class="text-sm text-slate-500 font-bold uppercase">Total Live Content</p><h3 class="font-baloo text-4xl font-bold text-emerald" id="stat-live">...</h3></div>
          <div class="text-5xl opacity-20">âœ…</div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex items-center justify-between">
          <div><p class="text-sm text-slate-500 font-bold uppercase">Pending Approvals</p><h3 class="font-baloo text-4xl font-bold text-orange-500" id="stat-pending">...</h3></div>
          <div class="text-5xl opacity-20">â³</div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center bg-slate-50 gap-4">
          <h2 class="font-baloo text-xl font-bold text-dark">Submissions Awaiting Approval</h2>
          <div class="flex gap-4 w-full md:w-auto">
            <select id="teacher-filter" class="px-4 py-2 rounded-lg border border-slate-200 outline-none text-sm font-bold text-slate-600 bg-white flex-1" onchange="applyFilter()">
              <option value="ALL">Show All Teachers</option>
            </select>
            <button onclick="fetchData()" class="text-sky font-bold text-sm bg-blue-50 px-4 py-2 rounded-lg hover:bg-blue-100 whitespace-nowrap">ğŸ”„ Refresh</button>
          </div>
        </div>
        <div class="divide-y border-slate-100" id="submission-list"></div>
      </div>
    </main>
  </div>

  <div id="review-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
      <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
        <h3 class="font-baloo text-xl font-bold text-dark" id="modal-header-title">Review Content</h3>
        <button onclick="closeModal()" class="text-2xl text-slate-400">&times;</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1">
        <div class="inline-flex items-center gap-2 bg-blue-50 text-sky px-3 py-1.5 rounded-lg text-sm font-bold mb-4 border border-blue-100">
          ğŸ‘¨â€ğŸ« Authored by: <span id="modal-author">Teacher Name</span>
        </div>
        <h2 class="text-2xl font-bold text-dark mb-4" id="modal-title">Title</h2>
        <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
          <div id="modal-content-view" class="prose max-w-none"></div>
          <div id="modal-content-edit" class="hidden"><div id="admin-quill" class="bg-white"></div></div>
        </div>
      </div>
      <div id="modal-footer-view" class="px-6 py-4 border-t flex justify-end gap-4 bg-slate-50 rounded-b-2xl">
        <button onclick="rejectAction()" class="px-6 py-2 rounded-xl font-bold text-rose border border-rose-200">Reject & Delete</button>
        <button onclick="enableEditMode()" class="px-6 py-2 rounded-xl font-bold text-sky border border-blue-200">âœï¸ Edit HTML</button>
        <button id="approve-btn" onclick="approveAction()" class="px-6 py-2 rounded-xl font-bold text-white bg-emerald shadow-lg hover:bg-emerald-600 transition">Approve & Push Live</button>
      </div>
      <div id="modal-footer-edit" class="hidden px-6 py-4 border-t flex justify-end gap-4 bg-slate-50 rounded-b-2xl">
        <button onclick="cancelEdit()" class="px-6 py-2 rounded-xl font-bold text-slate-500 border border-slate-300">Cancel Edit</button>
        <button onclick="saveEdit()" class="px-6 py-2 rounded-xl font-bold text-white bg-sky shadow-lg">ğŸ’¾ Save Edit</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-2xl font-bold transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

<script type="module">
  import { getPendingContent, approveContent, rejectContent, loginUser, logoutUser, getAdminStats, auth } from './firebase-engine.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  let pendingData = [];
  let currentItem = null;
  let adminQuill = null;

  // --- PERSISTENT LOGIN LISTENER ---
  onAuthStateChanged(auth, (user) => {
    document.getElementById('auth-loader').classList.add('hidden');
    
    // Check if logged in AND it is the admin email
    if (user && user.email === 'admin@ertodisha.in') {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      window.fetchData();
    } else {
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
    }
  });

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = 'admin@ertodisha.in'; 
    const password = document.getElementById('admin-password').value;
    const btn = document.getElementById('login-btn');

    try {
      btn.innerText = "Authenticating...";
      await loginUser(email, password);
      // onAuthStateChanged handles the screen switch
    } catch(error) {
      alert("Incorrect Admin Password.");
      btn.innerText = "Access Secure DB";
    }
  });

  window.logout = async () => { await logoutUser(); location.reload(); };

  window.fetchData = async () => {
    document.getElementById('submission-list').innerHTML = `<div class="p-8 text-center text-slate-500">â³ Fetching securely from cloud...</div>`;
    const [data, stats] = await Promise.all([getPendingContent(), getAdminStats()]);
    pendingData = data;
    
    document.getElementById('stat-live').innerText = stats.live;
    document.getElementById('stat-pending').innerText = stats.pending;

    const filter = document.getElementById('teacher-filter');
    filter.innerHTML = '<option value="ALL">Show All Teachers</option>';
    const uniqueTeachers = [...new Set(pendingData.map(item => item.author))];
    uniqueTeachers.forEach(t => filter.innerHTML += `<option value="${t}">${t}</option>`);
    window.applyFilter();
  };

  window.applyFilter = () => {
    const selectedTeacher = document.getElementById('teacher-filter').value;
    const filteredData = selectedTeacher === "ALL" ? pendingData : pendingData.filter(i => i.author === selectedTeacher);
    renderList(filteredData);
  }

  function renderList(dataToRender) {
    const list = document.getElementById('submission-list');
    list.innerHTML = '';
    if (dataToRender.length === 0) { list.innerHTML = `<div class="p-8 text-center text-emerald-500 font-bold">ğŸ‰ Zero pending submissions for this selection!</div>`; return; }

    dataToRender.forEach(item => {
      list.innerHTML += `
        <div class="p-6 hover:bg-slate-50 flex justify-between items-center gap-4">
          <div>
            <div class="flex gap-2 items-center mb-2">
              <span class="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-sky uppercase tracking-wide">${item.typeName}</span>
              <span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">Class ${item.class} â€¢ ${item.subject}</span>
            </div>
            <h3 class="font-bold text-lg text-dark">${item.title}</h3>
            <p class="text-sm font-bold text-slate-500 mt-1">ğŸ‘¨â€ğŸ« By ${item.author}</p>
          </div>
          <button onclick="openModal('${item.id}')" class="px-6 py-2 bg-sky text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition">Review</button>
        </div>`;
    });
  }

  window.openModal = (id) => {
    currentItem = pendingData.find(i => i.id === id);
    window.cancelEdit();
    document.getElementById('modal-title').innerText = currentItem.title;
    document.getElementById('modal-author').innerText = currentItem.author;
    if (currentItem.type === 'quiz') {
      document.getElementById('modal-content-view').innerHTML = `<pre class="text-xs bg-slate-800 text-green-400 p-4 rounded-lg overflow-x-auto">${JSON.stringify(currentItem.content, null, 2)}</pre>`;
    } else {
      document.getElementById('modal-content-view').innerHTML = currentItem.content;
    }
    document.getElementById('review-modal').classList.remove('hidden');
  };

  window.closeModal = () => document.getElementById('review-modal').classList.add('hidden');

  window.enableEditMode = () => {
    if(currentItem.type === 'quiz') return alert("Direct JSON editing for quizzes is disabled. Reject and ask teacher to fix.");
    document.getElementById('modal-header-title').innerText = "Editing HTML...";
    document.getElementById('modal-content-view').classList.add('hidden');
    document.getElementById('modal-footer-view').classList.add('hidden');
    document.getElementById('modal-content-edit').classList.remove('hidden');
    document.getElementById('modal-footer-edit').classList.remove('hidden');
    if (!adminQuill) adminQuill = new Quill('#admin-quill', { theme: 'snow', modules: { formula: true, toolbar: [[{ 'header': [1, 2] }],['bold', 'italic'],[{ 'list': 'ordered'}, { 'list': 'bullet' }],['image', 'formula'],['clean']] }});
    adminQuill.root.innerHTML = currentItem.content;
  };

  window.cancelEdit = () => {
    document.getElementById('modal-header-title').innerText = "Review Content";
    document.getElementById('modal-content-view').classList.remove('hidden');
    document.getElementById('modal-footer-view').classList.remove('hidden');
    document.getElementById('modal-content-edit').classList.add('hidden');
    document.getElementById('modal-footer-edit').classList.add('hidden');
  };

  window.saveEdit = () => {
    currentItem.content = adminQuill.root.innerHTML;
    document.getElementById('modal-content-view').innerHTML = currentItem.content;
    window.cancelEdit();
  };

  window.approveAction = async () => {
    document.getElementById('approve-btn').innerText = "Pushing Live...";
    await approveContent(currentItem);
    window.closeModal();
    window.fetchData();
    showToast("âœ… Content Approved & Pushed Live!", "bg-emerald-500");
  };

  window.rejectAction = async () => {
    if(confirm("Permanently delete this submission?")) {
      await rejectContent(currentItem.id);
      window.closeModal();
      window.fetchData();
      showToast("âŒ Content Rejected and Deleted", "bg-rose-500");
    }
  };

  function showToast(message, bgColorClass) {
    const toast = document.getElementById('toast');
    toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-2xl font-bold transform translate-y-20 opacity-0 transition-all duration-300 z-50 ${bgColorClass}`;
    toast.innerText = message;
    setTimeout(() => toast.classList.remove('translate-y-20', 'opacity-0'), 100);
    setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
  }
</script>
</body>
</html>