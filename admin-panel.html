<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel ‚Äì ERT Odisha</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config = { theme: { extend: { colors: { sky: '#3A86FF', sun: '#FFBE0B', dark: '#1A1A2E', bg: '#F0F7FF', emerald: '#06D6A0', rose: '#FF6B6B'}, fontFamily: { baloo: ['"Baloo 2"', 'cursive'], nunito: ['Nunito', 'sans-serif']}}}}</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
  body { font-family: 'Nunito', sans-serif; background-color: #F0F7FF; }
  .ql-container { font-family: 'Nunito', sans-serif; font-size: 1rem; background: white; border-radius: 0 0 8px 8px; min-height: 200px;}
  .ql-toolbar { background: #f8fafc; border-radius: 8px 8px 0 0; }
  ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  .tab-btn.active { background: #1A1A2E; color: white; border-color: #1A1A2E;}
</style>
</head>
<body class="text-slate-700">

  <div id="auth-loader" class="min-h-screen flex items-center justify-center bg-dark">
    <div class="text-white font-bold text-xl animate-pulse">Checking Security Clearance...</div>
  </div>

  <div id="login-screen" class="hidden min-h-screen flex items-center justify-center bg-dark p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
      <div class="text-5xl mb-4">üõ°Ô∏è</div>
      <h1 class="font-baloo text-3xl font-bold text-dark mb-2">Admin Portal</h1>
      <p class="text-slate-500 mb-6 text-sm">Logging in as <strong class="text-dark">admin@ertodisha.in</strong></p>
      
      <form id="login-form" class="space-y-4">
        <input type="password" id="admin-password" placeholder="Admin Password" required class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 outline-none text-center">
        <button type="submit" id="login-btn" class="w-full bg-sky text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition shadow-lg">Access Secure DB</button>
      </form>
    </div>
  </div>

  <div id="dashboard" class="hidden min-h-screen flex flex-col">
    <header class="bg-white shadow-sm sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-10 h-10 bg-dark text-white rounded-lg flex items-center justify-center text-xl">üõ°Ô∏è</div>
          <span class="font-baloo text-xl font-bold text-dark hidden md:block">ERT <span class="text-sky">Odisha</span> Admin</span>
        </div>
        
        <div class="flex gap-2 bg-slate-100 p-1 rounded-xl">
          <button onclick="switchTab('tab-pending')" id="btn-tab-pending" class="tab-btn active px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 transition">Pending <span id="badge-pending" class="bg-orange-500 text-white px-1.5 py-0.5 rounded text-xs ml-1">0</span></button>
          <button onclick="switchTab('tab-live')" id="btn-tab-live" class="tab-btn px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 transition">Live Content</button>
        </div>

        <button onclick="logout()" class="text-sm font-bold text-slate-500 hover:text-rose">Logout</button>
      </div>
    </header>

    <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8 relative">
      <div class="grid grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex items-center justify-between">
          <div><p class="text-sm text-slate-500 font-bold uppercase">Total Live Content</p><h3 class="font-baloo text-3xl md:text-4xl font-bold text-emerald" id="stat-live">...</h3></div>
          <div class="text-5xl opacity-20 hidden sm:block">‚úÖ</div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex items-center justify-between">
          <div><p class="text-sm text-slate-500 font-bold uppercase">Pending Approvals</p><h3 class="font-baloo text-3xl md:text-4xl font-bold text-orange-500" id="stat-pending">...</h3></div>
          <div class="text-5xl opacity-20 hidden sm:block">‚è≥</div>
        </div>
      </div>

      <div id="tab-pending" class="block">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
          <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h2 class="font-baloo text-xl font-bold text-dark">Awaiting Approval</h2>
            <button onclick="fetchData()" class="text-sky font-bold text-sm bg-blue-50 px-4 py-2 rounded-lg hover:bg-blue-100">üîÑ Refresh</button>
          </div>
          <div class="divide-y border-slate-100" id="pending-list"></div>
        </div>
      </div>

      <div id="tab-live" class="hidden">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
          <div class="p-6 border-b border-slate-100 bg-slate-50">
            <div class="flex justify-between items-center mb-4">
              <h2 class="font-baloo text-xl font-bold text-dark">Live Database Manager</h2>
              <button onclick="fetchData()" class="text-sky font-bold text-sm bg-blue-50 px-4 py-2 rounded-lg hover:bg-blue-100">üîÑ Refresh DB</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
              <input type="text" id="filter-search" placeholder="Search title..." class="col-span-2 md:col-span-1 px-3 py-2 rounded-lg border outline-none text-sm font-bold" onkeyup="applyLiveFilter()">
              <select id="filter-teacher" class="px-3 py-2 rounded-lg border outline-none text-sm font-bold text-slate-600" onchange="applyLiveFilter()"><option value="ALL">All Teachers</option></select>
              <select id="filter-class" class="px-3 py-2 rounded-lg border outline-none text-sm font-bold text-slate-600" onchange="applyLiveFilter()"><option value="ALL">All Classes</option>
                <option value="1">Class 1</option><option value="2">Class 2</option><option value="3">Class 3</option><option value="4">Class 4</option><option value="5">Class 5</option><option value="6">Class 6</option><option value="7">Class 7</option><option value="8">Class 8</option>
              </select>
              <select id="filter-subject" class="px-3 py-2 rounded-lg border outline-none text-sm font-bold text-slate-600" onchange="applyLiveFilter()"><option value="ALL">All Subjects</option>
                <option value="odia">Odia</option><option value="math">Maths</option><option value="eng">English</option><option value="sci">Science</option><option value="soc">Social</option><option value="paribesa">EVS</option>
              </select>
              <select id="filter-chapter" class="px-3 py-2 rounded-lg border outline-none text-sm font-bold text-slate-600" onchange="applyLiveFilter()"><option value="ALL">All Chapters</option>
                <option value="01">Ch 1</option><option value="02">Ch 2</option><option value="03">Ch 3</option><option value="04">Ch 4</option><option value="05">Ch 5</option><option value="06">Ch 6</option><option value="07">Ch 7</option>
              </select>
              <select id="filter-type" class="px-3 py-2 rounded-lg border outline-none text-sm font-bold text-slate-600" onchange="applyLiveFilter()"><option value="ALL">All Content</option>
                <option value="notes">Notes</option>
                <optgroup label="Lesson Plans"><option value="lesson_1">Lesson Note 1</option><option value="lesson_2">Lesson Note 2</option><option value="lesson_3">Lesson Note 3</option><option value="lesson_4">Lesson Note 4</option><option value="lesson_5">Lesson Note 5</option><option value="lesson_6">Lesson Note 6</option><option value="lesson_7">Lesson Note 7</option><option value="lesson_8">Lesson Note 8</option><option value="lesson_9">Lesson Note 9</option><option value="lesson_10">Lesson Note 10</option></optgroup>
                <option value="innovative">Innovative Practices</option><option value="tlm">TLM</option><option value="qa_very_short">Q&A - Very Short</option><option value="qa_short">Q&A - Short</option><option value="qa_long">Q&A - Long</option><option value="qa_objective">Q&A - Objective</option><option value="quiz">Interactive Quiz</option>
              </select>
            </div>
          </div>
          <div class="divide-y border-slate-100" id="live-list"></div>
        </div>
      </div>
    </main>
  </div>

  <div id="review-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
      <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
        <div class="flex items-center gap-3">
          <h3 class="font-baloo text-xl font-bold text-dark" id="modal-header-title">Review Content</h3>
          <span id="modal-badge-status" class="px-2 py-0.5 rounded text-xs font-bold text-white uppercase"></span>
        </div>
        <button onclick="closeModal()" class="text-2xl text-slate-400">&times;</button>
      </div>
      
      <div class="p-6 overflow-y-auto flex-1">
        <div class="flex justify-between items-start mb-4">
          <div class="w-full mr-4">
            <div class="inline-flex items-center gap-2 bg-blue-50 text-sky px-3 py-1.5 rounded-lg text-sm font-bold mb-2 border border-blue-100">üë®‚Äçüè´ By: <span id="modal-author">Teacher</span></div>
            
            <!-- NEW: DYNAMIC TITLE / EDIT TITLE -->
            <h2 class="text-2xl font-bold text-dark border-b border-slate-100 pb-2" id="modal-title-view">Title</h2>
            <input type="text" id="modal-title-edit" class="hidden w-full text-xl font-bold text-dark p-3 border-2 border-sky rounded-xl outline-none mb-2 shadow-sm" placeholder="Edit Title / Question">
            
          </div>
          <button id="btn-view-student" onclick="openStudentView()" class="hidden bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-700 whitespace-nowrap">üéì View as Student</button>
        </div>
        
        <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
          <div id="modal-content-view" class="prose max-w-none overflow-x-auto"></div>
          
          <div id="modal-content-edit" class="hidden">
            <!-- HTML EDITOR -->
            <div id="admin-quill-wrapper" class="hidden"><div id="admin-quill" class="bg-white"></div></div>
            
            <!-- NEW CLEAN QUIZ EDITOR UI -->
            <div id="admin-quiz-wrapper" class="hidden space-y-3 bg-white p-6 rounded-xl border border-slate-200">
              <label class="font-bold text-xs text-slate-500 uppercase tracking-wider">Quiz Question</label>
              <textarea id="edit-quiz-q" class="w-full p-3 rounded-xl border outline-none bg-slate-50 mb-2"></textarea>
              
              <label class="font-bold text-xs text-slate-500 uppercase tracking-wider">Options</label>
              <div class="grid grid-cols-2 gap-3 mb-2">
                <input id="edit-quiz-opt0" class="w-full p-3 rounded-xl border outline-none bg-slate-50" placeholder="Option A">
                <input id="edit-quiz-opt1" class="w-full p-3 rounded-xl border outline-none bg-slate-50" placeholder="Option B">
                <input id="edit-quiz-opt2" class="w-full p-3 rounded-xl border outline-none bg-slate-50" placeholder="Option C">
                <input id="edit-quiz-opt3" class="w-full p-3 rounded-xl border outline-none bg-slate-50" placeholder="Option D">
              </div>
              
              <label class="font-bold text-xs text-slate-500 uppercase tracking-wider">Correct Answer</label>
              <select id="edit-quiz-ans" class="w-full p-3 rounded-xl border outline-none bg-emerald-50 text-emerald-800 font-bold">
                 <option value="0">Option A</option>
                 <option value="1">Option B</option>
                 <option value="2">Option C</option>
                 <option value="3">Option D</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div id="modal-footer" class="px-6 py-4 border-t flex justify-end gap-3 bg-slate-50 rounded-b-2xl"></div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-2xl font-bold transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

<script type="module">
  import { getPendingContent, getLiveContentAll, approveContent, rejectContent, deleteLiveContent, updateLiveContent, loginUser, logoutUser, getAdminStats, auth } from './firebase-engine.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  let pendingData = []; let liveData = [];
  let currentItem = null; let currentMode = 'pending';
  let adminQuill = null;

  onAuthStateChanged(auth, (user) => {
    document.getElementById('auth-loader').classList.add('hidden');
    if (user && user.email === 'admin@ertodisha.in') {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      window.fetchData();
    } else {
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
    }
  });

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('login-btn');
    try {
      btn.innerText = "Authenticating...";
      await loginUser('admin@ertodisha.in', document.getElementById('admin-password').value);
    } catch(error) { alert("Incorrect Admin Password."); btn.innerText = "Access Secure DB"; }
  });

  window.logout = async () => { await logoutUser(); location.reload(); };

  window.switchTab = (tabId) => {
    document.getElementById('tab-pending').classList.add('hidden');
    document.getElementById('tab-live').classList.add('hidden');
    document.getElementById(tabId).classList.remove('hidden');
    document.getElementById('btn-tab-pending').classList.remove('active');
    document.getElementById('btn-tab-live').classList.remove('active');
    document.getElementById('btn-' + tabId).classList.add('active');
  };

  window.fetchData = async () => {
    document.getElementById('pending-list').innerHTML = `<div class="p-8 text-center text-slate-500">‚è≥ Fetching Pending...</div>`;
    document.getElementById('live-list').innerHTML = `<div class="p-8 text-center text-slate-500">‚è≥ Fetching Live DB...</div>`;
    
    const [pData, lData, stats] = await Promise.all([getPendingContent(), getLiveContentAll(), getAdminStats()]);
    pendingData = pData; liveData = lData;
    
    document.getElementById('stat-live').innerText = stats.live;
    document.getElementById('stat-pending').innerText = stats.pending;
    document.getElementById('badge-pending').innerText = stats.pending;

    const filter = document.getElementById('filter-teacher');
    filter.innerHTML = '<option value="ALL">All Teachers</option>';
    const uniqueTeachers = [...new Set(liveData.map(item => item.author))];
    uniqueTeachers.forEach(t => filter.innerHTML += `<option value="${t}">${t}</option>`);

    renderPending();
    window.applyLiveFilter();
  };

  function renderPending() {
    const list = document.getElementById('pending-list');
    list.innerHTML = '';
    if (pendingData.length === 0) { list.innerHTML = `<div class="p-8 text-center text-emerald-500 font-bold">üéâ Inbox Zero! No pending submissions.</div>`; return; }
    pendingData.forEach((item, index) => {
      const slNo = index + 1;
      list.innerHTML += `
        <div class="p-6 hover:bg-slate-50 flex justify-between items-center gap-4">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full bg-orange-100 text-orange-600 font-bold text-sm">${slNo}</div>
            <div>
              <div class="flex gap-2 items-center mb-1">
                <span class="px-2 py-0.5 rounded text-xs font-bold bg-orange-100 text-orange-600 uppercase">Reviewing</span>
                <span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">Class ${item.class} ‚Ä¢ ${item.subject} ‚Ä¢ ${item.typeName}</span>
              </div>
              <h3 class="font-bold text-lg text-dark">${item.title}</h3>
              <p class="text-sm font-bold text-slate-500">üë®‚Äçüè´ By ${item.author}</p>
            </div>
          </div>
          <button onclick="openModal('${item.id}', 'pending')" class="px-6 py-2 bg-sky text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition">Review</button>
        </div>`;
    });
  }

  window.applyLiveFilter = () => {
    const sSearch = document.getElementById('filter-search').value.toLowerCase();
    const sTeacher = document.getElementById('filter-teacher').value;
    const sClass = document.getElementById('filter-class').value;
    const sSub = document.getElementById('filter-subject').value;
    const sChap = document.getElementById('filter-chapter').value;
    const sType = document.getElementById('filter-type').value;

    const filteredData = liveData.filter(i => {
      const matchSearch = i.title.toLowerCase().includes(sSearch) || i.author.toLowerCase().includes(sSearch);
      return matchSearch && 
            (sTeacher === "ALL" || i.author === sTeacher) &&
            (sClass === "ALL" || i.class == sClass) &&
            (sSub === "ALL" || i.subject === sSub) &&
            (sChap === "ALL" || i.chapter === sChap) &&
            (sType === "ALL" || i.type === sType);
    });
    renderLive(filteredData);
  }

  function renderLive(data) {
    const list = document.getElementById('live-list');
    list.innerHTML = '';
    if (data.length === 0) { list.innerHTML = `<div class="p-8 text-center text-slate-400 font-bold">No live items match this filter.</div>`; return; }
    data.forEach((item, index) => {
      const slNo = index + 1;
      list.innerHTML += `
        <div class="p-6 hover:bg-slate-50 flex justify-between items-center gap-4">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-slate-600 font-bold text-sm">${slNo}</div>
            <div>
              <div class="flex gap-2 items-center mb-1">
                <span class="px-2 py-0.5 rounded text-xs font-bold bg-emerald-100 text-emerald-700 uppercase">Live</span>
                <span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">Class ${item.class} ‚Ä¢ ${item.subject} ‚Ä¢ Ch ${item.chapter}</span>
              </div>
              <h3 class="font-bold text-lg text-dark">${item.title} <span class="text-sm font-normal text-slate-400">(${item.typeName})</span></h3>
              <p class="text-sm font-bold text-slate-500">üë®‚Äçüè´ ${item.author}</p>
            </div>
          </div>
          <button onclick="openModal('${item.id}', 'live')" class="px-5 py-2 border border-slate-300 text-slate-600 font-bold rounded-xl shadow-sm hover:bg-slate-100 transition">Manage</button>
        </div>`;
    });
  }

  window.openModal = (id, mode) => {
    currentMode = mode;
    currentItem = mode === 'pending' ? pendingData.find(i => i.id === id) : liveData.find(i => i.id === id);
    
    document.getElementById('modal-title-view').innerText = currentItem.title;
    document.getElementById('modal-author').innerText = currentItem.author;
    
    const badge = document.getElementById('modal-badge-status');
    if(mode === 'pending') { badge.className = "px-2 py-0.5 rounded text-xs font-bold text-white uppercase bg-orange-500"; badge.innerText = "Pending Approval"; }
    else { badge.className = "px-2 py-0.5 rounded text-xs font-bold text-white uppercase bg-emerald-500"; badge.innerText = "Live Published"; }

    const btnStudent = document.getElementById('btn-view-student');
    if(mode === 'live') { btnStudent.classList.remove('hidden'); } else { btnStudent.classList.add('hidden'); }

    if (currentItem.type === 'quiz') {
      document.getElementById('modal-content-view').innerHTML = `<pre class="text-xs bg-slate-800 text-green-400 p-4 rounded-lg overflow-x-auto">${JSON.stringify(currentItem.content, null, 2)}</pre>`;
    } else {
      document.getElementById('modal-content-view').innerHTML = currentItem.content;
    }
    
    // Reset view states
    document.getElementById('modal-title-view').classList.remove('hidden');
    document.getElementById('modal-title-edit').classList.add('hidden');
    document.getElementById('modal-content-view').classList.remove('hidden');
    document.getElementById('modal-content-edit').classList.add('hidden');
    
    buildModalFooter();
    document.getElementById('review-modal').classList.remove('hidden');
  };

  function buildModalFooter() {
    const footer = document.getElementById('modal-footer');
    if (currentMode === 'pending') {
      footer.innerHTML = `
        <button onclick="rejectAction()" class="px-5 py-2 rounded-xl font-bold text-rose border border-rose-200">Reject & Delete</button>
        <button onclick="enableEditMode()" class="px-5 py-2 rounded-xl font-bold text-sky border border-blue-200">‚úèÔ∏è Edit Data</button>
        <button onclick="approveAction()" class="px-5 py-2 rounded-xl font-bold text-white bg-emerald shadow-lg hover:bg-emerald-600 transition">Approve & Push Live</button>
      `;
    } else {
      footer.innerHTML = `
        <button onclick="deleteLive()" class="px-5 py-2 rounded-xl font-bold text-rose border border-rose-200">üóëÔ∏è Unpublish</button>
        <button onclick="enableEditMode()" class="px-5 py-2 rounded-xl font-bold text-sky border border-blue-200">‚úèÔ∏è Edit Data</button>
        <button onclick="closeModal()" class="px-5 py-2 rounded-xl font-bold text-slate-500 bg-slate-100 shadow-sm">Close</button>
      `;
    }
  }

  window.closeModal = () => document.getElementById('review-modal').classList.add('hidden');
  window.openStudentView = () => window.open(`viewer.html#class=${currentItem.class}&subject=${currentItem.subject}&chapter=${currentItem.chapter}&type=${currentItem.type}`, '_blank');

  window.enableEditMode = () => {
    // Reveal Edit Inputs
    document.getElementById('modal-title-view').classList.add('hidden');
    document.getElementById('modal-title-edit').classList.remove('hidden');
    document.getElementById('modal-title-edit').value = currentItem.title;
    
    document.getElementById('modal-content-view').classList.add('hidden');
    document.getElementById('modal-content-edit').classList.remove('hidden');
    
    document.getElementById('modal-footer').innerHTML = `
      <button onclick="cancelEdit()" class="px-5 py-2 rounded-xl font-bold text-slate-500 border border-slate-300">Cancel Edit</button>
      <button onclick="saveEdit()" class="px-5 py-2 rounded-xl font-bold text-white bg-sky shadow-lg">üíæ Save Changes</button>
    `;

    // Initialize the correct editor based on Type
    if(currentItem.type === 'quiz') {
      document.getElementById('admin-quill-wrapper').classList.add('hidden');
      document.getElementById('admin-quiz-wrapper').classList.remove('hidden');
      
      const qData = currentItem.content[0];
      document.getElementById('edit-quiz-q').value = qData.q;
      document.getElementById('edit-quiz-opt0').value = qData.options[0];
      document.getElementById('edit-quiz-opt1').value = qData.options[1];
      document.getElementById('edit-quiz-opt2').value = qData.options[2];
      document.getElementById('edit-quiz-opt3').value = qData.options[3];
      document.getElementById('edit-quiz-ans').value = qData.answer;
      
    } else {
      document.getElementById('admin-quiz-wrapper').classList.add('hidden');
      document.getElementById('admin-quill-wrapper').classList.remove('hidden');
      if (!adminQuill) adminQuill = new Quill('#admin-quill', { theme: 'snow', modules: { formula: true, toolbar: [[{ 'header': [1, 2] }],['bold', 'italic'],[{ 'list': 'ordered'}, { 'list': 'bullet' }],['image', 'formula'],['clean']] }});
      adminQuill.root.innerHTML = currentItem.content;
    }
  };

  window.cancelEdit = () => {
    document.getElementById('modal-title-view').classList.remove('hidden');
    document.getElementById('modal-title-edit').classList.add('hidden');
    document.getElementById('modal-content-view').classList.remove('hidden');
    document.getElementById('modal-content-edit').classList.add('hidden');
    buildModalFooter();
  };

  window.saveEdit = async () => {
    let newTitle = document.getElementById('modal-title-edit').value;
    let newContent = null;

    if(currentItem.type === 'quiz') {
      // Rebuild the secure array from the Admin Form
      newContent = [{
        q: document.getElementById('edit-quiz-q').value,
        options: [
          document.getElementById('edit-quiz-opt0').value,
          document.getElementById('edit-quiz-opt1').value,
          document.getElementById('edit-quiz-opt2').value,
          document.getElementById('edit-quiz-opt3').value
        ],
        answer: parseInt(document.getElementById('edit-quiz-ans').value)
      }];
      document.getElementById('modal-content-view').innerHTML = `<pre class="text-xs bg-slate-800 text-green-400 p-4 rounded-lg overflow-x-auto">${JSON.stringify(newContent, null, 2)}</pre>`;
    } else {
      newContent = adminQuill.root.innerHTML;
      document.getElementById('modal-content-view').innerHTML = newContent;
    }

    currentItem.title = newTitle;
    currentItem.content = newContent;
    document.getElementById('modal-title-view').innerText = newTitle;
    
    if(currentMode === 'live') {
      try {
        await updateLiveContent(currentItem.id, newTitle, newContent);
        showToast("‚úÖ Live Content Updated!", "bg-sky");
        window.fetchData(); // Silently refresh the row
      } catch(e) { alert("Error saving live edit."); }
    } else {
      showToast("Edit applied locally. Click Approve to push live.", "bg-slate-800");
    }
    window.cancelEdit();
  };

  window.approveAction = async () => {
    document.getElementById('modal-footer').innerHTML = `<span class="font-bold text-sky">Pushing Live...</span>`;
    await approveContent(currentItem);
    window.closeModal();
    window.fetchData();
    showToast("‚úÖ Content Approved & Pushed Live!", "bg-emerald-500");
  };

  window.rejectAction = async () => {
    if(confirm("Permanently delete this pending submission?")) {
      await rejectContent(currentItem.id);
      window.closeModal();
      window.fetchData();
      showToast("‚ùå Pending Content Rejected", "bg-rose-500");
    }
  };

  window.deleteLive = async () => {
    if(confirm("DANGER: This will permanently remove this content from the Student App. Continue?")) {
      await deleteLiveContent(currentItem.id);
      window.closeModal();
      window.fetchData();
      showToast("üóëÔ∏è Live Content Deleted", "bg-rose-500");
    }
  };

  function showToast(message, bgColorClass) {
    const toast = document.getElementById('toast');
    toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-2xl font-bold transform translate-y-20 opacity-0 transition-all duration-300 z-50 ${bgColorClass}`;
    toast.innerText = message;
    setTimeout(() => toast.classList.remove('translate-y-20', 'opacity-0'), 100);
    setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
  }
</script>
</body>
</html>