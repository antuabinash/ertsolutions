<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Content Viewer ‚Äì ERT Odisha</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config = { theme: { extend: { colors: { sky: '#3A86FF', sun: '#FFBE0B', dark: '#1A1A2E', bg: '#F0F7FF'}, fontFamily: { baloo: ['"Baloo 2"', 'cursive'], nunito: ['Nunito', 'sans-serif']}}}}</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js"></script>
<style>
  body { font-family: 'Nunito', sans-serif; background-color: #F0F7FF; -webkit-tap-highlight-color: transparent;}
  .nav-bar { background: white; padding: 15px 5%; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 12px rgba(58,134,255,0.05); }
  .back-btn { width: 40px; height: 40px; background: #f8fafc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #1A1A2E; cursor: pointer; border: 1px solid #e2e8f0; text-decoration: none;}
  
  .reading-content p, .prose p { font-size: 1.1rem; line-height: 1.8; color: #334155; margin-bottom: 1em; }
  .reading-content ul, .prose ul { padding-left: 1.5rem; margin-bottom: 1em; list-style-type: disc;}
  .reading-content ol, .prose ol { padding-left: 1.5rem; margin-bottom: 1em; list-style-type: decimal;}
  .reading-content li, .prose li { margin-bottom: 0.5em; color: #334155; }
  .reading-content img, .prose img { max-width: 100%; border-radius: 12px; margin: 1em 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
</style>
</head>
<body class="text-slate-700">

  <nav class="nav-bar">
    <a href="#" onclick="window.history.back(); return false;" class="back-btn">‚ùÆ</a>
    <div>
      <h1 class="font-baloo text-xl font-bold text-dark leading-tight truncate max-w-[250px]" id="page-title">Loading...</h1>
      <p class="text-xs font-bold text-sky uppercase tracking-widest" id="page-subtitle">...</p>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-5 py-8">
    
    <div id="loader" class="text-center p-12 hidden">
      <div class="text-4xl animate-bounce mb-4">‚òÅÔ∏è</div>
      <p class="font-bold text-sky text-lg">Fetching content securely...</p>
    </div>

    <div id="error-state" class="text-center p-12 hidden bg-white rounded-3xl shadow-sm border border-slate-100">
      <div class="text-5xl mb-4 opacity-50" id="error-icon">üìÇ</div>
      <h2 class="font-baloo text-2xl font-bold text-dark mb-2" id="error-title">No Content Yet</h2>
      <p class="text-slate-500" id="error-desc">Teachers haven't published content for this specific section yet. Check back soon!</p>
      <button onclick="window.history.back()" class="mt-6 bg-sky text-white px-6 py-2 rounded-xl font-bold shadow-sm hover:bg-blue-600 transition">Go Back</button>
    </div>

    <!-- LESSON PLAN MENU (1-10) -->
    <div id="view-lesson-menu" class="hidden">
      <h3 class="font-baloo text-2xl font-bold text-dark mb-6 text-center">Select Lesson Note</h3>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4" id="lesson-tiles-container">
        <!-- Generated by JS -->
      </div>
    </div>

    <!-- Q&A MENU -->
    <div id="view-qa-menu" class="hidden">
      <h3 class="font-baloo text-2xl font-bold text-dark mb-6 text-center">Select Question Type</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <a id="link-qa-vshort" href="#" class="bg-gradient-to-br from-[#FFF3CC] to-[#FFE680] p-6 rounded-2xl flex items-center gap-4 text-yellow-800 shadow-sm transition transform active:scale-95"><div class="text-4xl">‚ö°</div><div><h4 class="font-bold text-lg">Very Short Answer</h4><p class="text-sm opacity-80">‡¨Ö‡¨§‡¨ø ‡¨∏‡¨Ç‡¨ï‡≠ç‡¨∑‡¨ø‡¨™‡≠ç‡¨§ ‡¨â‡¨§‡≠ç‡¨§‡¨∞</p></div></a>
        <a id="link-qa-short" href="#" class="bg-gradient-to-br from-[#D4F5EC] to-[#A8EDD9] p-6 rounded-2xl flex items-center gap-4 text-emerald-800 shadow-sm transition transform active:scale-95"><div class="text-4xl">üìù</div><div><h4 class="font-bold text-lg">Short Answer</h4><p class="text-sm opacity-80">‡¨∏‡¨Ç‡¨ï‡≠ç‡¨∑‡¨ø‡¨™‡≠ç‡¨§ ‡¨â‡¨§‡≠ç‡¨§‡¨∞</p></div></a>
        <a id="link-qa-long" href="#" class="bg-gradient-to-br from-[#D6EAFF] to-[#AACEFF] p-6 rounded-2xl flex items-center gap-4 text-blue-800 shadow-sm transition transform active:scale-95"><div class="text-4xl">‚úçÔ∏è</div><div><h4 class="font-bold text-lg">Long Answer</h4><p class="text-sm opacity-80">‡¨¶‡≠Ä‡¨∞‡≠ç‡¨ò ‡¨â‡¨§‡≠ç‡¨§‡¨∞</p></div></a>
        <a id="link-qa-obj" href="#" class="bg-gradient-to-br from-[#EDE0FF] to-[#D4BAFF] p-6 rounded-2xl flex items-center gap-4 text-purple-800 shadow-sm transition transform active:scale-95"><div class="text-4xl">üéØ</div><div><h4 class="font-bold text-lg">Objective</h4><p class="text-sm opacity-80">‡¨¨‡¨∏‡≠ç‡¨§‡≠Å‡¨®‡¨ø‡¨∑‡≠ç‡¨† ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨®</p></div></a>
      </div>
    </div>

    <!-- NEW: QA FLASHCARD UI -->
    <div id="view-qa-flashcard" class="hidden max-w-2xl mx-auto">
      <div class="bg-white rounded-3xl p-6 md:p-10 shadow-sm border border-slate-100 relative">
         <div class="absolute top-0 right-0 bg-blue-50 text-sky px-3 py-1 rounded-bl-xl rounded-tr-3xl text-xs font-bold border-b border-l border-blue-100 shadow-sm" id="qa-author-badge">üë®‚Äçüè´ By Teacher</div>
         
         <div class="flex justify-between items-center mb-6 mt-4">
           <span class="font-bold text-slate-500 bg-slate-50 border border-slate-200 px-4 py-1.5 rounded-full text-sm" id="qa-progress">Q: 1/5</span>
         </div>
         
         <!-- Question Text -->
         <h2 class="font-baloo text-2xl md:text-3xl font-bold text-dark mb-8 leading-snug" id="qa-question-text">Question goes here?</h2>
         
         <div class="text-center" id="qa-btn-container">
            <button class="bg-sky text-white font-bold text-lg px-8 py-3 rounded-xl shadow-lg hover:bg-blue-600 transition w-full md:w-auto" onclick="toggleQAAnswer()">üëÅÔ∏è View Answer</button>
         </div>

         <!-- Answer Text -->
         <div id="qa-answer-container" class="hidden mt-8 pt-8 border-t-2 border-dashed border-slate-100">
            <h3 class="text-xs font-bold text-emerald-600 uppercase tracking-widest mb-4 bg-emerald-50 inline-block px-3 py-1 rounded-lg">Explanation / Answer</h3>
            <div id="qa-answer-text" class="text-slate-700 text-lg leading-relaxed prose max-w-none">Answer goes here</div>
         </div>
      </div>
      
      <!-- Navigation -->
      <div class="flex justify-between items-center mt-6 gap-4">
         <button onclick="prevQA()" id="qa-prev-btn" class="bg-white text-slate-600 font-bold px-6 py-3.5 rounded-xl shadow-sm border border-slate-200 disabled:opacity-40 disabled:cursor-not-allowed flex-1">‚ùÆ Prev</button>
         <button onclick="nextQA()" id="qa-next-btn" class="bg-dark text-white font-bold px-6 py-3.5 rounded-xl shadow-md disabled:opacity-40 disabled:cursor-not-allowed flex-1">Next ‚ùØ</button>
      </div>
    </div>

    <!-- STANDARD READING VIEW -->
    <div id="view-reading" class="hidden bg-white p-6 md:p-10 rounded-3xl shadow-sm border border-slate-100 reading-content">
      <div id="reading-body" class="w-full"></div>
    </div>

    <!-- QUIZ VIEW -->
    <div id="view-quiz" class="hidden max-w-2xl mx-auto">
      <div id="quiz-intro" class="bg-white rounded-3xl p-8 text-center shadow-sm border border-slate-100 mb-6">
        <div class="text-6xl mb-4">üèÜ</div>
        <h2 class="font-baloo text-3xl font-bold text-dark mb-2">Ready to Play?</h2>
        <p class="text-slate-500 mb-6">Test your knowledge on this chapter!</p>
        <button onclick="startQuiz()" class="bg-sky text-white font-bold text-xl px-10 py-3 rounded-full shadow-lg">Start Quiz</button>
      </div>

      <div id="quiz-area" class="hidden">
        <div class="flex justify-between items-center mb-4 px-2">
          <span class="font-bold text-slate-500 bg-white px-3 py-1 rounded-full shadow-sm text-sm" id="quiz-progress">Q: 1/10</span>
          <span class="font-bold text-sun bg-white px-3 py-1 rounded-full shadow-sm text-sm" id="quiz-score">Score: 0</span>
        </div>
        
        <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-slate-100 mb-6">
          <h3 class="font-baloo text-xl md:text-2xl font-bold text-dark mb-6 leading-relaxed" id="quiz-question">Question text here?</h3>
          <div class="space-y-3" id="quiz-options"></div>
        </div>
      </div>

      <div id="quiz-result" class="hidden bg-white rounded-3xl p-8 text-center shadow-sm border border-slate-100">
        <div class="text-6xl mb-4" id="result-emoji">üéâ</div>
        <h2 class="font-baloo text-3xl font-bold text-dark mb-2" id="result-title">Quiz Complete!</h2>
        <p class="text-lg text-slate-600 mb-6">You scored <strong class="text-sky text-2xl" id="final-score">0</strong> out of <span id="total-qs">0</span></p>
        <button onclick="location.reload()" class="bg-slate-100 text-slate-600 font-bold px-8 py-3 rounded-xl hover:bg-slate-200">Play Again</button>
      </div>
    </div>

  </main>

<script type="module">
  import { fetchLiveContent } from './firebase-engine.js';

  let currentContentType = '';
  
  // Quiz Variables
  let quizData = [];
  let currentQIndex = 0;
  let score = 0;

  // Flashcard Variables
  let qaDataArray = [];
  let currentQAIndex = 0;

  function hideAllViews() {
    document.getElementById('loader').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('view-qa-menu').classList.add('hidden');
    document.getElementById('view-lesson-menu').classList.add('hidden');
    document.getElementById('view-reading').classList.add('hidden');
    document.getElementById('view-quiz').classList.add('hidden');
    document.getElementById('view-qa-flashcard').classList.add('hidden');
  }

  async function parseURL() {
    const hashString = window.location.hash.substring(1);
    const urlParams = new URLSearchParams(hashString);
    const classId = urlParams.get('class') || '1';
    const subjectKey = urlParams.get('subject') || 'odia';
    const chapterNum = urlParams.get('chapter') || '01';
    currentContentType = urlParams.get('type') || 'notes';

    document.getElementById('page-subtitle').innerText = `Class ${classId} ‚Ä¢ Ch ${chapterNum}`;
    hideAllViews();

    // 1. Render Q&A Menu
    if (currentContentType === 'qa') {
      document.getElementById('page-title').innerText = "Question & Answer";
      const baseHash = `#class=${classId}&subject=${subjectKey}&chapter=${chapterNum}&type=`;
      document.getElementById('link-qa-vshort').href = baseHash + 'qa_very_short';
      document.getElementById('link-qa-short').href = baseHash + 'qa_short';
      document.getElementById('link-qa-long').href = baseHash + 'qa_long';
      document.getElementById('link-qa-obj').href = baseHash + 'qa_objective';
      document.getElementById('view-qa-menu').classList.remove('hidden');
      return;
    } 

    // 2. Render Lesson Plan Sub-Menu
    if (currentContentType === 'lesson_menu') {
      document.getElementById('page-title').innerText = "Lesson Plans";
      let lessonHTML = '';
      for(let i=1; i<=10; i++) {
         lessonHTML += `<a href="#class=${classId}&subject=${subjectKey}&chapter=${chapterNum}&type=lesson_${i}" class="bg-gradient-to-br from-[#D4F5EC] to-[#A8EDD9] p-4 rounded-2xl flex flex-col items-center justify-center gap-2 text-emerald-800 shadow-sm transition transform active:scale-95 text-center"><div class="text-3xl">üìã</div><h4 class="font-bold text-sm">Lesson Note ${i}</h4></a>`;
      }
      document.getElementById('lesson-tiles-container').innerHTML = lessonHTML;
      document.getElementById('view-lesson-menu').classList.remove('hidden');
      return;
    }

    // 3. Fetch Real Content
    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('page-title').innerText = "Loading...";

    try {
      const dbContent = await fetchLiveContent(classId, subjectKey, chapterNum, currentContentType);
      document.getElementById('loader').classList.add('hidden');

      if (!dbContent || !dbContent.content) {
        document.getElementById('page-title').innerText = "Content Unavailable";
        document.getElementById('error-state').classList.remove('hidden');
        return;
      }

      document.getElementById('page-title').innerText = dbContent.title || dbContent.typeName;
      
      // Route to correct renderer
      if (currentContentType === 'quiz') {
        quizData = dbContent.content; 
        document.getElementById('view-quiz').classList.remove('hidden');
        document.getElementById('quiz-intro').classList.remove('hidden');
      } else if (currentContentType.startsWith('qa_')) {
        qaDataArray = dbContent.content; // Expecting Array from Engine!
        startQAFlashcards();
      } else {
        document.getElementById('reading-body').innerHTML = dbContent.content;
        document.getElementById('view-reading').classList.remove('hidden');
      }

    } catch (err) {
      console.error(err);
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('error-state').classList.remove('hidden');
    }
  }

  // --- QA FLASHCARD LOGIC ---
  function startQAFlashcards() {
    if(!qaDataArray || qaDataArray.length === 0) return;
    currentQAIndex = 0;
    renderQAFlashcard();
    document.getElementById('view-qa-flashcard').classList.remove('hidden');
  }

  function renderQAFlashcard() {
    const qa = qaDataArray[currentQAIndex];
    document.getElementById('qa-progress').innerText = `Question: ${currentQAIndex + 1} of ${qaDataArray.length}`;
    document.getElementById('qa-author-badge').innerText = `üë®‚Äçüè´ By ${qa.author}`;
    document.getElementById('qa-question-text').innerText = qa.title;
    document.getElementById('qa-answer-text').innerHTML = qa.content;
    
    // Reset view state
    document.getElementById('qa-answer-container').classList.add('hidden');
    document.getElementById('qa-btn-container').classList.remove('hidden');
    
    // Setup buttons
    document.getElementById('qa-prev-btn').disabled = (currentQAIndex === 0);
    document.getElementById('qa-next-btn').disabled = (currentQAIndex === qaDataArray.length - 1);
  }

  window.toggleQAAnswer = () => {
    document.getElementById('qa-btn-container').classList.add('hidden');
    document.getElementById('qa-answer-container').classList.remove('hidden');
  };

  window.nextQA = () => { if (currentQAIndex < qaDataArray.length - 1) { currentQAIndex++; renderQAFlashcard(); } };
  window.prevQA = () => { if (currentQAIndex > 0) { currentQAIndex--; renderQAFlashcard(); } };


  // --- QUIZ LOGIC ---
  window.startQuiz = () => {
    if(!quizData || quizData.length === 0) return;
    currentQIndex = 0; score = 0;
    quizData = quizData.sort(() => Math.random() - 0.5);
    document.getElementById('quiz-intro').classList.add('hidden');
    document.getElementById('quiz-area').classList.remove('hidden');
    loadQuestion();
  };

  function loadQuestion() {
    const q = quizData[currentQIndex];
    document.getElementById('quiz-progress').innerText = `Q: ${currentQIndex + 1} / ${quizData.length}`;
    document.getElementById('quiz-score').innerText = `Score: ${score}`;
    document.getElementById('quiz-question').innerText = q.q;
    
    const optsDiv = document.getElementById('quiz-options');
    optsDiv.innerHTML = '';
    
    q.options.forEach((opt, idx) => {
      const btn = document.createElement('button');
      btn.className = "w-full text-left p-4 rounded-xl border-2 border-slate-100 font-bold text-slate-600 hover:border-sky hover:bg-blue-50 transition active:scale-95";
      btn.innerText = opt;
      btn.onclick = () => checkAnswer(idx, q.answer, btn);
      optsDiv.appendChild(btn);
    });
  }

  function checkAnswer(selected, correct, btnNode) {
    const buttons = document.getElementById('quiz-options').querySelectorAll('button');
    buttons.forEach(b => b.disabled = true);
    if (selected === correct) { btnNode.classList.add('bg-emerald-100', 'border-emerald-500', 'text-emerald-800'); score++; } 
    else { btnNode.classList.add('bg-rose-100', 'border-rose-500', 'text-rose-800'); buttons[correct].classList.add('bg-emerald-100', 'border-emerald-500', 'text-emerald-800'); }
    setTimeout(() => { currentQIndex++; if (currentQIndex < quizData.length) { loadQuestion(); } else { showResults(); } }, 1200);
  }

  function showResults() {
    document.getElementById('quiz-area').classList.add('hidden');
    document.getElementById('quiz-result').classList.remove('hidden');
    document.getElementById('final-score').innerText = score;
    document.getElementById('total-qs').innerText = quizData.length;
    const p = score / quizData.length;
    document.getElementById('result-emoji').innerText = p === 1 ? "üèÜ" : p >= 0.7 ? "üåü" : p >= 0.4 ? "üëç" : "üìö";
  }

  window.addEventListener('hashchange', parseURL);
  parseURL(); 
</script>

</body>
</html>